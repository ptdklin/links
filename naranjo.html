<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шкала Наранжо - Оценка НЛР</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c7fb8;
            --secondary-color: #7fcdbb;
            --accent-color: #edf8b1;
            --text-color: #253238;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-bg);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px 0;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            margin-right: 15px;
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .patient-info {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .required::after {
            content: " *";
            color: var(--danger-color);
        }
        
        input, select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(44, 127, 184, 0.2);
        }
        
        .error {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .info-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            font-weight: 600;
        }
        
        h3 {
            color: var(--secondary-color);
            margin: 25px 0 15px;
            font-weight: 500;
        }
        
        p {
            margin-bottom: 15px;
        }
        
        .scale-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .scale-table th {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
            padding: 12px 15px;
            font-weight: 500;
        }
        
        .scale-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .scale-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .scale-table tr:hover {
            background-color: var(--accent-color);
        }
        
        .interpretation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .interpretation-table th, .interpretation-table td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        
        .interpretation-table th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 500;
        }
        
        .interpretation-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .assessment-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .question-block {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
        }
        
        .question-text {
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .option {
            display: flex;
            align-items: center;
        }
        
        .option input {
            margin-right: 8px;
            width: auto;
        }
        
        .results-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .score-display {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .definite {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }
        
        .probable {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
            border: 2px solid var(--warning-color);
        }
        
        .possible {
            background-color: rgba(255, 193, 7, 0.1);
            color: #b38f00;
            border: 2px solid #b38f00;
        }
        
        .doubtful {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d6fa5;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-icon {
            margin-right: 8px;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .logo {
                justify-content: center;
                margin-bottom: 15px;
            }
            
            .header-actions {
                justify-content: center;
                width: 100%;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">⚕️</div>
                    <div>
                        <h1>Шкала Наранжо</h1>
                        <div class="subtitle">Оценка причинности нежелательных лекарственных реакций</div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="resetHeaderBtn">
                        <span class="btn-icon">🔄</span> Сбросить предыдущие данные
                    </button>
                </div>
            </div>
        </header>
        
        <section class="patient-info">
            <h2>Информация о пациенте</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="patientFIO" class="required">ФИО пациента</label>
                    <input type="text" id="patientFIO" placeholder="Введите фамилию, имя и отчество" required>
                    <div class="error-message" id="fioError">Поле ФИО обязательно для заполнения</div>
                </div>
                <div class="form-group">
                    <label for="patientBirthDate" class="required">Дата рождения</label>
                    <input type="date" id="patientBirthDate" required>
                    <div class="error-message" id="birthDateError">Поле даты рождения обязательно для заполнения</div>
                </div>
                <div class="form-group">
                    <label for="fillingDate" class="required">Дата заполнения</label>
                    <input type="date" id="fillingDate" required>
                    <div class="error-message" id="fillingDateError">Поле даты заполнения обязательно для заполнения</div>
                </div>
                <div class="form-group">
                    <label for="suspectedDrug" class="required">Подозреваемый препарат</label>
                    <input type="text" id="suspectedDrug" placeholder="Название препарата" required>
                    <div class="error-message" id="drugError">Поле препарата обязательно для заполнения</div>
                </div>
                <div class="form-group">
                    <label for="adverseReaction" class="required">Нежелательная реакция</label>
                    <input type="text" id="adverseReaction" placeholder="Описание реакции" required>
                    <div class="error-message" id="reactionError">Поле реакции обязательно для заполнения</div>
                </div>
            </div>
        </section>
        
        <section class="info-section">
            <h2>📝 Общие сведения о шкале Наранжо</h2>
            <p><strong>Шкала Наранжо (The Naranjo Adverse Drug Reaction Probability Scale)</strong> — это стандартизированный алгоритм, разработанный в 1991 году группой ученых под руководством Цезаря Наранжо (Cesar A. Naranjo) в Университете Торонто для оценки причинно-следственной связи между приемом лекарственного препарата и возникновением нежелательной лекарственной реакции (НЛР).</p>
            
            <h3>Назначение шкалы</h3>
            <p><strong>Ключевая цель:</strong> стандартизировать оценку причинности НЛР, уменьшив вариабельность решений, присущую клиническому суждению.</p>
            <p><strong>Основная сфера применения:</strong> изначально шкала создавалась для контролируемых клинических испытаний и исследований при регистрации новых лекарственных средств, но благодаря простоте она стала широко использоваться и в рутинной практике фармаконадзора.</p>
        </section>
        
        <section class="info-section">
            <h2>⚖️ Алгоритм и критерии оценки</h2>
            <p>Шкала состоит из 10 вопросов, на которые следует давать ответы "Да", "Нет" или "Не знаю". Каждый ответ оценивается в баллах от -1 до +2. <strong>Сумма баллов определяет категорию вероятности.</strong></p>
            
            <h3>Интерпретация результатов</h3>
            <table class="interpretation-table">
                <thead>
                    <tr>
                        <th>Баллы</th>
                        <th>Категория</th>
                        <th>Описание</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>≥ 9</td>
                        <td>Определенная (Definite)</td>
                        <td>Реакция имеет временную связь, соответствует известному действию препарата, подтверждена позитивной реакцией на отмену и повторным появлением при возобновлении приема.</td>
                    </tr>
                    <tr>
                        <td>5-8</td>
                        <td>Вероятная (Probable)</td>
                        <td>Реакция имеет временную связь и соответствует известному действию препарата, подтверждена позитивной реакцией на отмену, но не подтверждена повторным введением.</td>
                    </tr>
                    <tr>
                        <td>1-4</td>
                        <td>Возможная (Possible)</td>
                        <td>Реакция имеет временную связь, но может быть объяснена другими причинами (болезнью, другими препаратами).</td>
                    </tr>
                    <tr>
                        <td>≤ 0</td>
                        <td>Сомнительная (Doubtful)</td>
                        <td>Реакция, скорее всего, связана с иными факторами, а не с препаратом.</td>
                    </tr>
                </tbody>
            </table>
            
            <p style="margin-top: 20px; font-style: italic; color: var(--primary-color);">
                Ниже представлены вопросы шкалы Наранжо, на которые необходимо ответить для определения категории вероятности нежелательной лекарственной реакции.
            </p>
        </section>
        
        <section class="info-section">
            <h2>💡 Ограничения и критические замечания</h2>
            <p>Несмотря на широкую распространенность, шкала Наранжо имеет ряд существенных ограничений, которые крайне важно учитывать при принятии клинических решений.</p>
            
            <h3>Основные ограничения</h3>
            <p><strong>Неспециализированность:</strong> Шкала не учитывает специфику определенных типов реакций, например, лекарственного поражения печени (гепатотоксичности). Для таких случаев существуют более подходящие инструменты (например, шкала RUCAM).</p>
            
            <p><strong>Зависимость от данных:</strong> Точность оценки напрямую зависит от полноты медицинской документации. Ответ "Не знаю" на ключевые вопросы (например, о повторном введении) снижает диагностическую ценность.</p>
            
            <p><strong>Этические ограничения:</strong> Повторное введение препарата (речлендж), дающее максимальные баллы, часто невыполнимо или неэтично в клинической практике.</p>
            
            <p><strong>Ориентация на клинические исследования:</strong> Некоторые вопросы (например, о применении плацебо) малоприменимы в рутинной клинической практике.</p>
        </section>
        
        <section class="info-section">
            <h2>⚖️ Сравнение с другими методами и заключение</h2>
            <p>Шкала Наранжо является одним из нескольких алгоритмов оценки причинности (наряду с алгоритмом Венулет, критериями ВОЗ и др.). Исследования показывают, что использование любых алгоритмов повышает согласованность оценок между разными специалистами по сравнению с опорой только на клиническое суждение.</p>
            
            <h3>Выводы для практикующего специалиста</h3>
            <p><strong>→ Инструмент, а не истина в последней инстанции</strong> → Шкала Наранжо — это стандартизированный опросник, который помогает структурировать клиническое мышление, но не может самостоятельно доказать или опровергнуть причинно-следственную связь.</p>
            
            <p><strong>→ Требует критического осмысления</strong> → Результат должен интерпретироваться в контексте конкретного клинического случая с учетом всех ограничений метода.</p>
            
            <p><strong>→ Выбор инструмента</strong> → Для определенных типов НЛР (идиосинкразических, отсроченных, иммуноопосредованных) могут быть предпочтительны другие, более специализированные шкалы.</p>
        </section>
        
        <section class="assessment-section">
            <h2>Оценка по шкале Наранжо</h2>
            
            <div class="question-block" id="question1">
                <div class="question-text">1. Имеются ли предыдущие убедительные сообщения о данной реакции?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q1" value="1" data-score="1">
                        <label>Да (+1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q1" value="0" data-score="0">
                        <label>Нет (0)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q1" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question2">
                <div class="question-text">2. Появилась ли нежелательная реакция после введения подозреваемого лекарства?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q2" value="1" data-score="2">
                        <label>Да (+2)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q2" value="0" data-score="-1">
                        <label>Нет (-1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q2" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question3">
                <div class="question-text">3. Улучшилось ли состояние после отмены препарата или введения антагониста?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q3" value="1" data-score="1">
                        <label>Да (+1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q3" value="0" data-score="0">
                        <label>Нет (0)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q3" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question4">
                <div class="question-text">4. Возобновилась ли реакция после повторного введения препарата?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q4" value="1" data-score="2">
                        <label>Да (+2)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q4" value="0" data-score="-1">
                        <label>Нет (-1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q4" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question5">
                <div class="question-text">5. Есть ли другие причины (кроме лекарства), которые могли вызвать реакцию?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q5" value="1" data-score="-1">
                        <label>Да (-1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q5" value="0" data-score="2">
                        <label>Нет (+2)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q5" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question6">
                <div class="question-text">6. Возобновилась ли реакция при использовании плацебо?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q6" value="1" data-score="-1">
                        <label>Да (-1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q6" value="0" data-score="1">
                        <label>Нет (+1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q6" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question7">
                <div class="question-text">7. Обнаружено ли лекарство в крови (др. жидкостях) в токсической концентрации?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q7" value="1" data-score="1">
                        <label>Да (+1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q7" value="0" data-score="0">
                        <label>Нет (0)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q7" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question8">
                <div class="question-text">8. Была ли реакция сильнее при увеличении дозы или слабее при ее уменьшении?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q8" value="1" data-score="1">
                        <label>Да (+1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q8" value="0" data-score="0">
                        <label>Нет (0)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q8" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question9">
                <div class="question-text">9. Была ли у пациента подобная реакция на этот/похожий препарат в прошлом?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q9" value="1" data-score="1">
                        <label>Да (+1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q9" value="0" data-score="0">
                        <label>Нет (0)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q9" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="question-block" id="question10">
                <div class="question-text">10. Подтверждалась ли нежелательная реакция объективными доказательствами?</div>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q10" value="1" data-score="1">
                        <label>Да (+1)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q10" value="0" data-score="0">
                        <label>Нет (0)</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q10" value="unknown" data-score="0">
                        <label>Не знаю (0)</label>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-success" id="saveResultsBtn">
                    <span class="btn-icon">💾</span> Посмотреть результаты
                </button>
                <button class="btn btn-success" id="downloadBottomBtn">
                    <span class="btn-icon">📊</span> Скачать в Excel
                </button>
            </div>
        </section>
        
        <section class="results-section" id="resultsSection" style="display: none;">
            <h2>Результаты оценки</h2>
            
            <div id="scoreDisplay" class="score-display">
                <!-- Результат будет отображаться здесь -->
            </div>
            
            <h3>Интерпретация</h3>
            <p id="interpretationText"></p>
            
            <h3>Рекомендации</h3>
            <p id="recommendationText"></p>
            
            <div class="actions">
                <button class="btn btn-success" id="saveResultsBottomBtn">
                    <span class="btn-icon">💾</span> Сохранить результаты
                </button>
                <button class="btn btn-success" id="downloadResultsBtn">
                    <span class="btn-icon">📊</span> Скачать в Excel
                </button>
            </div>
        </section>
        
        <footer>
            <p>© 2025 Шкала Наранжо для оценки причинности нежелательных лекарственных реакций.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Установка текущей даты по умолчанию
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fillingDate').value = today;
            
            // Обязательные поля
            const requiredFields = [
                { id: 'patientFIO', errorId: 'fioError' },
                { id: 'patientBirthDate', errorId: 'birthDateError' },
                { id: 'fillingDate', errorId: 'fillingDateError' },
                { id: 'suspectedDrug', errorId: 'drugError' },
                { id: 'adverseReaction', errorId: 'reactionError' }
            ];
            
            // Добавляем обработчики для валидации полей
            requiredFields.forEach(field => {
                const input = document.getElementById(field.id);
                const error = document.getElementById(field.errorId);
                
                input.addEventListener('blur', function() {
                    validateField(this, error);
                });
                
                input.addEventListener('input', function() {
                    if (this.classList.contains('error')) {
                        validateField(this, error);
                    }
                });
            });
            
            // Функция валидации поля
            function validateField(field, errorElement) {
                if (!field.value.trim()) {
                    field.classList.add('error');
                    errorElement.style.display = 'block';
                    return false;
                } else {
                    field.classList.remove('error');
                    errorElement.style.display = 'none';
                    return true;
                }
            }
            
            // Функция проверки всех обязательных полей
            function validateAllFields() {
                let isValid = true;
                
                requiredFields.forEach(field => {
                    const input = document.getElementById(field.id);
                    const error = document.getElementById(field.errorId);
                    
                    if (!validateField(input, error)) {
                        isValid = false;
                    }
                });
                
                return isValid;
            }
            
            // Обработчики для вопросов
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Подсветка выбранного вопроса
                    const questionBlock = this.closest('.question-block');
                    questionBlock.style.backgroundColor = '#e8f4fd';
                    questionBlock.style.borderLeftColor = '#2c7fb8';
                });
            });
            
            // Кнопка сброса в хедере
            document.getElementById('resetHeaderBtn').addEventListener('click', function() {
                resetForm();
            });
            
            // Кнопка сохранения результатов (в разделе вопросов)
            document.getElementById('saveResultsBtn').addEventListener('click', function() {
                if (!validateAllFields()) {
                    alert('Пожалуйста, заполните все обязательные поля перед сохранением результатов.');
                    return;
                }
                saveResults();
            });
            
            // Кнопка скачивания в Excel (в разделе вопросов)
            document.getElementById('downloadBottomBtn').addEventListener('click', function() {
                if (!validateAllFields()) {
                    alert('Пожалуйста, заполните все обязательные поля перед скачиванием файла.');
                    return;
                }
                downloadToExcel();
            });
            
            // Кнопка сохранения результатов (в разделе результатов)
            document.getElementById('saveResultsBottomBtn').addEventListener('click', function() {
                if (!validateAllFields()) {
                    alert('Пожалуйста, заполните все обязательные поля перед сохранением результатов.');
                    return;
                }
                saveResults();
            });
            
            // Кнопка скачивания в Excel (в разделе результатов)
            document.getElementById('downloadResultsBtn').addEventListener('click', function() {
                if (!validateAllFields()) {
                    alert('Пожалуйста, заполните все обязательные поля перед скачиванием файла.');
                    return;
                }
                downloadToExcel();
            });
            
            // Функция расчета баллов
            function calculateScore() {
                let totalScore = 0;
                const questions = document.querySelectorAll('.question-block');
                
                questions.forEach(question => {
                    const selectedOption = question.querySelector('input[type="radio"]:checked');
                    if (selectedOption) {
                        totalScore += parseInt(selectedOption.getAttribute('data-score'));
                    }
                });
                
                displayResults(totalScore);
            }
            
            // Функция отображения результатов
            function displayResults(score) {
                const resultsSection = document.getElementById('resultsSection');
                const scoreDisplay = document.getElementById('scoreDisplay');
                const interpretationText = document.getElementById('interpretationText');
                const recommendationText = document.getElementById('recommendationText');
                
                // Отображаем секцию с результатами
                resultsSection.style.display = 'block';
                
                // Устанавливаем баллы
                scoreDisplay.textContent = `Сумма баллов: ${score}`;
                
                // Определяем категорию и устанавливаем соответствующий стиль
                let category, interpretation, recommendation;
                
                if (score >= 9) {
                    category = 'definite';
                    interpretation = 'Определенная (Definite). Реакция имеет временную связь, соответствует известному действию препарата, подтверждена позитивной реакцией на отмену и повторным появлением при возобновлении приема.';
                    recommendation = 'Рекомендуется рассмотреть вопрос о внесении препарата в список противопоказаний для данного пациента и сообщить о случае в регуляторные органы.';
                } else if (score >= 5) {
                    category = 'probable';
                    interpretation = 'Вероятная (Probable). Реакция имеет временную связь и соответствует известному действию препарата, подтверждена позитивной реакцией на отмену, но не подтверждена повторным введением.';
                    recommendation = 'Следует рассмотреть возможность замены препарата на альтернативный и продолжить наблюдение за пациентом.';
                } else if (score >= 1) {
                    category = 'possible';
                    interpretation = 'Возможная (Possible). Реакция имеет временную связь, но может быть объяснена другими причинами (болезнью, другими препаратами).';
                    recommendation = 'Необходимо продолжить наблюдение и сбор дополнительной информации для уточнения причинно-следственной связи.';
                } else {
                    category = 'doubtful';
                    interpretation = 'Сомнительная (Doubtful). Реакция, скорее всего, связана с иными факторами, а не с препаратом.';
                    recommendation = 'Следует продолжить диагностический поиск других возможных причин возникшей реакции.';
                }
                
                // Устанавливаем класс для стилизации
                scoreDisplay.className = 'score-display ' + category;
                
                // Устанавливаем тексты
                interpretationText.textContent = interpretation;
                recommendationText.textContent = recommendation;
                
                // Прокручиваем к результатам
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Функция сброса формы
            function resetForm() {
                // Сбрасываем поля пациента
                document.getElementById('patientFIO').value = '';
                document.getElementById('patientBirthDate').value = '';
                document.getElementById('suspectedDrug').value = '';
                document.getElementById('adverseReaction').value = '';
                
                // Сбрасываем радиокнопки
                const radioButtons = document.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(radio => {
                    radio.checked = false;
                });
                
                // Сбрасываем стили вопросов
                const questions = document.querySelectorAll('.question-block');
                questions.forEach(question => {
                    question.style.backgroundColor = '#f8f9fa';
                    question.style.borderLeftColor = '#2c7fb8';
                });
                
                // Скрываем секцию результатов
                document.getElementById('resultsSection').style.display = 'none';
                
                // Убираем ошибки валидации
                requiredFields.forEach(field => {
                    const input = document.getElementById(field.id);
                    const error = document.getElementById(field.errorId);
                    input.classList.remove('error');
                    error.style.display = 'none';
                });
                
                alert('Все данные сброшены. Форма готова к заполнению заново.');
            }
            
            // Функция сохранения результатов
            function saveResults() {
                alert('Результаты сохранены в базе данных.');
                // В реальном приложении здесь был бы код для отправки данных на сервер
            }
            
            // Функция скачивания в Excel
            function downloadToExcel() {
                // Собираем данные пациента
                const patientData = {
                    fio: document.getElementById('patientFIO').value || 'Не указано',
                    birthDate: document.getElementById('patientBirthDate').value || 'Не указано',
                    fillingDate: document.getElementById('fillingDate').value || 'Не указано',
                    suspectedDrug: document.getElementById('suspectedDrug').value || 'Не указано',
                    adverseReaction: document.getElementById('adverseReaction').value || 'Не указано'
                };
                
                // Собираем ответы на вопросы
                const answers = [];
                for (let i = 1; i <= 10; i++) {
                    const question = document.getElementById(`question${i}`);
                    const selectedOption = question.querySelector('input[type="radio"]:checked');
                    let answerText = 'Не отвечено';
                    let score = 0;
                    
                    if (selectedOption) {
                        const labels = question.querySelectorAll('label');
                        labels.forEach(label => {
                            if (label.previousElementSibling.checked) {
                                answerText = label.textContent.trim();
                                score = parseInt(selectedOption.getAttribute('data-score'));
                            }
                        });
                    }
                    
                    answers.push({
                        question: question.querySelector('.question-text').textContent.trim(),
                        answer: answerText,
                        score: score
                    });
                }
                
                // Рассчитываем общий балл
                const totalScore = answers.reduce((sum, answer) => sum + answer.score, 0);
                
                // Определяем категорию
                let category;
                if (totalScore >= 9) {
                    category = 'Определенная (Definite)';
                } else if (totalScore >= 5) {
                    category = 'Вероятная (Probable)';
                } else if (totalScore >= 1) {
                    category = 'Возможная (Possible)';
                } else {
                    category = 'Сомнительная (Doubtful)';
                }
                
                // Создаем книгу Excel
                const wb = XLSX.utils.book_new();
                
                // Лист с данными пациента
                const patientSheetData = [
                    ['ОЦЕНКА ПО ШКАЛЕ НАРАНЖО'],
                    [],
                    ['ДАННЫЕ ПАЦИЕНТА'],
                    ['ФИО', patientData.fio],
                    ['Дата рождения', patientData.birthDate],
                    ['Дата заполнения', patientData.fillingDate],
                    ['Подозреваемый препарат', patientData.suspectedDrug],
                    ['Нежелательная реакция', patientData.adverseReaction],
                    [],
                    ['РЕЗУЛЬТАТЫ ОЦЕНКИ'],
                    ['Сумма баллов', totalScore],
                    ['Категория', category],
                    [],
                    ['ОТВЕТЫ НА ВОПРОСЫ ШКАЛЫ НАРАНЖО']
                ];
                
                // Добавляем вопросы и ответы
                answers.forEach((answer, index) => {
                    patientSheetData.push([`Вопрос ${index + 1}`, answer.question]);
                    patientSheetData.push(['Ответ', answer.answer]);
                    patientSheetData.push(['Баллы', answer.score]);
                    patientSheetData.push([]);
                });
                
                const patientSheet = XLSX.utils.aoa_to_sheet(patientSheetData);
                
                // Устанавливаем выравнивание для всех ячеек по левому краю
                const range = XLSX.utils.decode_range(patientSheet['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = {c:C, r:R};
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        if (!patientSheet[cell_ref]) continue;
                        if (!patientSheet[cell_ref].s) patientSheet[cell_ref].s = {};
                        patientSheet[cell_ref].s.alignment = { horizontal: 'left' };
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, patientSheet, 'Оценка по шкале Наранжо');
                
                // Лист с информацией о шкале
                const infoSheetData = [
                    ['ШКАЛА НАРАНЖО - ИНФОРМАЦИЯ'],
                    [],
                    ['Описание'],
                    ['Шкала Наранжо (The Naranjo Adverse Drug Reaction Probability Scale) — это стандартизированный алгоритм, разработанный в 1991 году группой ученых под руководством Цезаря Наранжо (Cesar A. Naranjo) в Университете Торонто для оценки причинно-следственной связи между приемом лекарственного препарата и возникновением нежелательной лекарственной реакции (НЛР).'],
                    [],
                    ['Назначение'],
                    ['Ключевая цель: стандартизировать оценку причинности НЛР, уменьшив вариабельность решений, присущую клиническому суждению.'],
                    ['Основная сфера применения: изначально шкала создавалась для контролируемых клинических испытаний и исследований при регистрации новых лекарственных средств, но благодаря простоте она стала широко использоваться и в рутинной практике фармаконадзора.'],
                    [],
                    ['ИНТЕРПРЕТАЦИЯ РЕЗУЛЬТАТОВ'],
                    ['Баллы', 'Категория', 'Описание'],
                    ['≥ 9', 'Определенная (Definite)', 'Реакция имеет временную связь, соответствует известному действию препарата, подтверждена позитивной реакцией на отмену и повторным появлением при возобновлении приема.'],
                    ['5-8', 'Вероятная (Probable)', 'Реакция имеет временную связь и соответствует известному действию препарата, подтверждена позитивной реакцией на отмену, но не подтверждена повторным введением.'],
                    ['1-4', 'Возможная (Possible)', 'Реакция имеет временную связь, но может быть объяснена другими причинами (болезнью, другими препаратами).'],
                    ['≤ 0', 'Сомнительная (Doubtful)', 'Реакция, скорее всего, связана с иными факторами, а не с препаратом.']
                ];
                
                const infoSheet = XLSX.utils.aoa_to_sheet(infoSheetData);
                
                // Устанавливаем выравнивание для всех ячеек по левому краю
                const infoRange = XLSX.utils.decode_range(infoSheet['!ref']);
                for (let R = infoRange.s.r; R <= infoRange.e.r; ++R) {
                    for (let C = infoRange.s.c; C <= infoRange.e.c; ++C) {
                        const cell_address = {c:C, r:R};
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        if (!infoSheet[cell_ref]) continue;
                        if (!infoSheet[cell_ref].s) infoSheet[cell_ref].s = {};
                        infoSheet[cell_ref].s.alignment = { horizontal: 'left' };
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, infoSheet, 'Информация о шкале');
                
                // Генерируем имя файла
                const fileName = `Шкала_Наранжо_${patientData.fio.split(' ')[0] || 'пациент'}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                
                // Сохраняем файл
                XLSX.writeFile(wb, fileName);
            }
        });
    </script>
</body>
</html>
