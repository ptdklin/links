<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чек-лист проверки организации противотуберкулезной помощи</title>
    <style>
        :root {
            --primary-color: #2c7fb8;
            --secondary-color: #7fcdbb;
            --light-color: #f0f9ff;
            --border-color: #ddd;
            --completed-color: #e6f7e6;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
            font-weight: bold;
        }
        
        .branch-info {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            line-height: 1.6;
        }
        
        .branch-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .branch-details {
            font-size: 1rem;
        }
        
        .timestamp {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .timestamp label {
            font-weight: bold;
        }
        
        .timestamp input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .auto-save-status {
            margin-left: auto;
            font-size: 0.9rem;
            color: #666;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .section.collapsed {
            max-height: 60px;
        }
        
        .section.expanded {
            max-height: 800px;
        }
        
        .section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 1.1rem;
            flex: 1;
        }
        
        .section-content {
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        
        .section.expanded .section-content {
            display: block;
        }
        
        .question {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid var(--secondary-color);
            background-color: #f9f9f9;
            transition: background-color 0.3s;
            position: relative;
        }
        
        .question.completed {
            background-color: var(--completed-color);
        }
        
        .question-text {
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 1rem;
            padding-right: 50px;
            line-height: 1.4;
        }
        
        .check-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .check-button.checked {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .check-button.checked::after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .comment {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            min-height: 60px;
            font-size: 0.95rem;
            overflow: hidden;
            transition: height 0.2s;
        }
        
        .section-status {
            font-size: 0.8rem;
            background-color: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 20px;
        }
        
        button {
            padding: 12px 30px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #1a5a8a;
        }
        
        .save-btn {
            background-color: #4CAF50;
        }
        
        .save-btn:hover {
            background-color: #3d8b40;
        }
        
        .export-btn {
            background-color: #ff9800;
        }
        
        .export-btn:hover {
            background-color: #e68900;
        }
        
        .clear-btn {
            background-color: #f44336;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }

        .print-btn {
            background-color: #9c27b0;
        }
        
        .print-btn:hover {
            background-color: #7b1fa2;
        }

        /* Стили для печати */
        @media print {
            body {
                background-color: white;
                padding: 5mm !important;
                margin: 0 !important;
                font-size: 10pt;
            }
            
            .container {
                box-shadow: none;
                padding: 0 !important;
                max-width: none !important;
                margin: 0 !important;
                width: 100% !important;
            }
            
            .controls, .progress-bar, .auto-save-status {
                display: none !important;
            }
            
            /* Раскрываем все секции при печати */
            .section {
                max-height: none !important;
                margin-bottom: 10px !important;
                border: 1px solid #000 !important;
            }
            
            .section.collapsed {
                max-height: none !important;
            }
            
            .section-content {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 8px !important;
            }
            
            .section-header {
                cursor: default;
                background-color: #2c7fb8 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 6px 8px !important;
                margin-bottom: 0 !important;
            }
            
            .section-header h2 {
                font-size: 11pt !important;
                margin: 0 !important;
            }
            
            .sections-grid {
                display: block !important;
                grid-template-columns: none !important;
                gap: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .question {
                margin-bottom: 8px !important;
                padding: 6px !important;
            }
            
            .question-text {
                font-size: 9pt !important;
                margin-bottom: 5px !important;
                padding-right: 35px !important;
            }
            
            .check-button {
                width: 20px !important;
                height: 20px !important;
                top: 6px !important;
                right: 6px !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .check-button.checked::after {
                font-size: 10px !important;
            }
            
            .comment {
                min-height: 40px !important;
                padding: 4px !important;
                font-size: 9pt !important;
                border: 1px solid #000 !important;
            }
            
            .section-status {
                display: none !important;
            }
            
            header {
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }
            
            h1 {
                font-size: 14pt !important;
                margin-bottom: 5px !important;
            }
            
            .branch-info {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .branch-name {
                font-size: 11pt !important;
            }
            
            .branch-details {
                font-size: 10pt !important;
            }
            
            .timestamp {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .timestamp input {
                padding: 4px !important;
                font-size: 10pt !important;
            }
        }
        
        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header h2 {
                font-size: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Чек-лист проверки организации противотуберкулезной помощи</h1>
        </header>
        
        <div class="branch-info">
            <div class="branch-name">ГБУЗ МО МОКПТД</div>
            <div class="branch-details">Филиал "Клинский"</div>
        </div>
        
        <div class="timestamp">
            <label for="timestamp">Дата проверки:</label>
            <input type="date" id="timestamp" name="timestamp">
            <div class="auto-save-status" id="auto-save-status">Автосохранение включено</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="sections-grid" id="sections-container">
            <!-- Секции будут сгенерированы автоматически -->
        </div>
        
        <div class="controls">
            <button id="save-btn" class="save-btn">Сохранить данные</button>
            <button id="export-btn" class="export-btn">Скачать Excel файл</button>
            <button id="clear-btn" class="clear-btn">Очистить форму</button>
            <button id="print-btn" class="print-btn">Печать формы</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Данные чек-листа из документа по противотуберкулезной помощи
        const sections = [
            {
                title: "I. Документооборот и ведение медицинской карты (амбулаторная карта - АК)",
                questions: [
                    "Наличие и заполнение картонной обложки (ф. 025/у)",
                    "Наличие подписанных информированных согласий на медицинское вмешательство",
                    "Заполнение «Карты больного туберкулезом» (ф. 1030) - внутренняя обложка",
                    "Заполнение всего рекомендованного типового блока шаблонов",
                    "Документы вклеены в хронологическом порядке (осмотры, эпикризы, протоколы ВК)",
                    "Результаты рентгенологических исследований подшиты друг на друга в отдельном разделе",
                    "Результаты лабораторных исследований (кровь, моча, МБТ) и ЭКГ подшиты в отдельной картонной обложке в конце АК",
                    "Копии направлений на госпитализацию не вклеиваются в АК (хранятся в пакетах)",
                    "Наличие направления от специалиста общей лечебной сети (ОЛС)",
                    "Наличие протокола ВК о постановке на диспансерный учет",
                    "Наличие записи о факте госпитализации (подтвержденная данными ЕМИАС)",
                    "Наличие ежемесячных кратких записей о нахождении пациента в стационаре",
                    "Наличие выписного эпикриза из стационара",
                    "Наличие этапного эпикриза после стационарного лечения (с планом ведения)",
                    "Наличие протоколов ВК/ЦВК о снятии с бациллярного учета, закрытии полости распада, переводе на фазу продолжения (ФП)",
                    "Наличие этапного эпикриза после перевода на ФП и после контрольных исследований (с планом ведения)",
                    "Наличие протокола ВК о завершении курса химиотерапии и переводе в группу ЗГДУ",
                    "Наличие протокола ВК о прекращении диспансерного наблюдения"
                ],
                hasComment: true
            },
            {
                title: "II. Диагностика и контроль пациентов",
                questions: [
                    "Карты пациентов с неуточненным диагнозом (коробка №1) находятся в быстром доступе и проверяются ежедневно",
                    "Диагноз установлен в течение 14 дней с начала обследования",
                    "Карты пациентов с ожидаемыми отдаленными результатами (КТ-контроль, ППС и т.д.) хранятся отдельно (коробка №2)",
                    "В дневнике отражены все мероприятия по поиску и привлечению пациентов, прервавших лечение/дообследование",
                    "Лечащий врач уведомил заведующего отделением о пациентах, прервавших лечение",
                    "Данные о пациентах, прервавших лечение, внесены в журнал движения контингентов или отдельный список/журнал учета оторвавшихся",
                    "Пациенту вручены и разъяснены уведомления об обязательном обследовании или лечении, подписанные им",
                    "Проведены беседы с использованием наглядных материалов («Агит-папка»), показаны снимки КТ/рентгена",
                    "Для мотивации к хирургическому лечению использован QR-код с информацией для пациентов",
                    "При смене места жительства пациента подготовлено и направлено обращение в противотуберкулезную службу другого региона/Москвы",
                    "Копия обращения и ответ (при наличии) вклеены в АК",
                    "Диспансерное наблюдение прекращено только решением ВК после исчерпания мер поиска",
                    "Для пациентов 4-5 РХТ решение о прекращении наблюдения согласовано с заведующим филиалом",
                    "При наличии оснований (ст. 10 ФЗ-77) подготовлен полный пакет документов для суда/прокуратуры"
                ],
                hasComment: true
            },
            {
                title: "III. Лечение и мониторинг",
                questions: [
                    "Все диагностические, лечебные и реабилитационные мероприятия назначены в строгом соответствии с актуальными клиническими рекомендациями",
                    "Частота и перечень контрольных исследований соответствуют клиническим рекомендациям",
                    "Используется памятка по мониторингу побочных реакций (НПР)",
                    "Препараты выдаются на срок до 10 дней",
                    "В день выдачи в бумажной АК сделана дневниковая запись (даты совпадают с журналом выдачи)",
                    "Пациент расписывается в журнале выдачи препаратов",
                    "Выдача осуществляется медсестрой на основании листа назначений",
                    "Организована сигнальная картотека с 32-мя разделителями для листов назначений",
                    "Листы неявившихся пациентов перемещены в соответствующую ячейку",
                    "Пациенту выдана памятка с схемой приема препаратов",
                    "Результаты консультации торакального хирурга отражены в системе «Барклай-стационар»",
                    "Участковый фтизиатр вносит данные о контроле и привлечении к хирургическому лечению в соответствующий раздел «Барклай»"
                ],
                hasComment: true
            },
            {
                title: "IV. Работа в очагах туберкулезной инфекции",
                questions: [
                    "Для каждого контактного заведена ф. 025/у",
                    "Оформлены карта эпидобследования очага и карта участковой медсестры",
                    "Периодичность посещений очага соблюдена в соответствии с типом очага",
                    "В дневниковых записях карт медсестры и эпидемиолога фиксируются только повторные визиты",
                    "Выполнен полный план работы в очаге: определение границ, поиск контактов, санпросветработа, текущая дезинфекция, изоляция источника, заключительная дезинфекция, обследование контактов в течение 14 дней",
                    "Контактным лицам вручена памятка по текущей дезинфекции",
                    "Срок наблюдения за контактными лицами соблюден (в зависимости от статуса бактериовыделителя и возраста контакта)",
                    "Алгоритм работы с новорожденными в очаге соблюден (изоляция, БЦЖ, дезинфекция и пр.)",
                    "Направлено письмо работодателю о необходимости проведения противоэпидемических мероприятий",
                    "При выезде имеется распечатанная памятка с обоснованием (п.861 СанПиН)",
                    "Достигнуто понимание с администрацией о необходимости предоставить списки всех сотрудников, а не только непосредственных контактов",
                    "Получено предписание Роспотребнадзора до выхода в очаг (для мотивации работодателя)",
                    "Оформлена ф. №30 на очаг (с указанием места работы и данных пациента)",
                    "Ведутся списки сотрудников с отметками об обследовании",
                    "Акт выхода в очаг заверен печатью организации",
                    "Копия акта заключительной дезинфекции на производстве получена и зарегистрирована",
                    "Для эффективного информирования сотрудников распространена ссылка: https://ptdklin.github.io/diaskin/"
                ],
                hasComment: true
            },
            {
                title: "V. Взаимодействие с общей лечебной сетью (ОЛС) и раннее выявление",
                questions: [
                    "Направлено письмо главному врачу ОЛС с просьбой обследовать контактных по подъезду/улице (без указания ФИО и номера квартиры пациента)",
                    "Получены от терапевтов списки жителей с датами предыдущей флюорографии",
                    "В случае позднего выявления направлено письмо главному врачу ЦРБ с требованием проведения разбора случая",
                    "Акт разбора случая позднего выявления хранится в пакете с документацией пациента",
                    "Составлен календарный план выходов в подразделения ОЛС на год (хранится в «Паспорте участка»)",
                    "После каждого посещения ОЛС составлен акт, подписанный руководителем поликлиники",
                    "Копия акта с отметкой о получении хранится, вторая копия направлена заведующему филиалом",
                    "Сформирован и распространен среди заведующих терапевтическими отделениями пакет документов по раннему выявлению (инфографика и нормативные акты, №144)"
                ],
                hasComment: true
            },
            {
                title: "VI. Организационные моменты и отчетность",
                questions: [
                    "Включены все необходимые документы в Паспорт участка: описание территории, план работы с контингентами, план санпросветработы, план по Приказу 333-р, график выездов в ОЛС",
                    "Все документы хранятся вместе, используются шаблоны",
                    "Ведутся все обязательные журналы (список на стр. 8 руководства)",
                    "Ведется журнал движения контингентов как часть Паспорта участка",
                    "Перед отпуском или длительным отсутствием информация о пациентах передана коллегам в письменном виде"
                ],
                hasComment: true
            },
            {
                title: "VII. Алгоритм постановки на диспансерный учет (Чек-лист самоконтроля)",
                questions: [
                    "Получено решение ВК о постановке на учет, запись внесена в журнал ВК (ф. 035/у)",
                    "Данные внесены в системы «Барклай» и ФРБТ",
                    "Поданы извещения в санэпиднадзор (ф. 089/у №147 и ф. 058/у №148)",
                    "Оформлено и вручено пациенту извещение об установлении диспансерного наблюдения, корешок сохранен",
                    "Обеспечена госпитализация пациента (при показаниях)",
                    "Оформлена «Карта больного туберкулезом» (ф. 1030) и типовой блок",
                    "Направлено письмо в ОЛС об обследовании контактных по подъезду",
                    "Получен список контактных от ОЛС",
                    "При позднем выявлении направлено письмо в ЦРБ о проведении разбора",
                    "Обследован бытовой очаг, оформлены карта эпидобследования и карта участковой медсестры",
                    "Направлено письмо работодателю для организации выхода в производственный очаг",
                    "Проведен выезд в производственный очаг, оформлен акт",
                    "Обследованы контактные лица в бытовом и производственном очагах",
                    "Данные пациента внесены в базу доноров",
                    "Получены акты о заключительной дезинфекции бытового и производственного очагов"
                ],
                hasComment: true
            },
            {
                title: "VIII. Ведение журналов",
                questions: [
                    "Журнал выхода в очаг туберкулезной инфекции",
                    "Журнал движения контингентов",
                    "Журнал выдачи препаратов",
                    "Журнал постановки кожных проб",
                    "Журнал передачи сведений о проживающих в очаге туберкулёзной инфекции",
                    "Журнал учёта заключительной дезинфекции в очаге туберкулезной инфекции",
                    "Журнал регистрации извещений о постановке на учёт или прекращения наблюдения",
                    "Журнал консультаций торакального хирурга",
                    "Журнал учета клинико-экспертной работы лечебно-профилактического учреждения (ЭВН)",
                    "Журнал учета клинико-экспертной работы лечебно-профилактического учреждения (текущий лечебный контроль-ТЛК)",
                    "Журнал учета инфекционных заболеваний ф. N 060/у (печатная форма)"
                ],
                hasComment: true
            }
        ];

        // Глобальные переменные
        let answers = {};
        let autoSaveInterval;
        let lastSaveTime = null;
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Установка текущей даты (без времени)
            const now = new Date();
            
            const timestampInput = document.getElementById('timestamp');
            // Форматируем дату для input[type="date"]
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            timestampInput.value = `${year}-${month}-${day}`;
            
            // Генерация секций
            generateSections();
            
            // Обновление прогресс-бара
            updateProgressBar();
            
            // Обработчики событий для кнопок
            document.getElementById('save-btn').addEventListener('click', saveToLocalStorage);
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('print-btn').addEventListener('click', printForm);
            
            // Загрузка сохраненных данных
            loadFromLocalStorage();
            
            // Запуск автосохранения каждые 3 минуты
            startAutoSave();
            
            // Автоматическое увеличение полей комментариев
            setupAutoResizeTextareas();
        });
        
        // Функция для печати формы
        function printForm() {
            // Раскрываем все секции перед печатью
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('collapsed');
                section.classList.add('expanded');
            });
            
            // Даем время на обновление DOM и затем печатаем
            setTimeout(() => {
                window.print();
            }, 100);
        }
        
        // Настройка автоматического изменения размера textarea
        function setupAutoResizeTextareas() {
            document.querySelectorAll('.comment').forEach(textarea => {
                // Устанавливаем начальную высоту
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
                
                // Обработчик изменения содержимого
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            });
        }
        
        // Запуск автосохранения
        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                saveToLocalStorage(true);
            }, 3 * 60 * 1000); // 3 минуты
        }
        
        // Генерация секций чек-листа
        function generateSections() {
            const container = document.getElementById('sections-container');
            
            sections.forEach((section, index) => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section collapsed';
                sectionElement.dataset.sectionIndex = index;
                
                // Заголовок секции
                const header = document.createElement('div');
                header.className = 'section-header';
                header.dataset.sectionIndex = index;
                
                const title = document.createElement('h2');
                title.textContent = section.title;
                
                const status = document.createElement('div');
                status.className = 'section-status';
                status.textContent = '0/' + (section.questions.length + 1); // +1 для дополнительной информации
                
                header.appendChild(title);
                header.appendChild(status);
                
                // Содержимое секции
                const content = document.createElement('div');
                content.className = 'section-content';
                
                // Вопросы секции
                section.questions.forEach((question, qIndex) => {
                    const questionElement = createQuestionElement(index, qIndex, question);
                    content.appendChild(questionElement);
                });
                
                // Дополнительная информация (всегда последним вопросом в секции)
                const additionalInfoElement = createQuestionElement(
                    index, 
                    section.questions.length, 
                    "Дополнительная информация"
                );
                content.appendChild(additionalInfoElement);
                
                sectionElement.appendChild(header);
                sectionElement.appendChild(content);
                
                // Обработчик для переключения секций с прокруткой наверх
                header.addEventListener('click', function() {
                    const sectionIndex = this.dataset.sectionIndex;
                    const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
                    
                    if (section.classList.contains('collapsed')) {
                        // Закрыть все секции
                        document.querySelectorAll('.section').forEach(s => {
                            s.classList.remove('expanded');
                            s.classList.add('collapsed');
                        });
                        // Открыть текущую
                        section.classList.remove('collapsed');
                        section.classList.add('expanded');
                        
                        // Прокрутка к верху секции
                        setTimeout(() => {
                            section.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }, 100);
                    } else {
                        // Закрыть текущую
                        section.classList.remove('expanded');
                        section.classList.add('collapsed');
                    }
                    
                    // После открытия секции обновить размер textarea
                    setTimeout(() => {
                        setupAutoResizeTextareas();
                    }, 100);
                });
                
                container.appendChild(sectionElement);
            });
        }
        
        // Создание элемента вопроса
        function createQuestionElement(sectionIndex, questionIndex, questionText) {
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            questionElement.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            
            const questionTextElement = document.createElement('div');
            questionTextElement.className = 'question-text';
            questionTextElement.textContent = questionText;
            
            const checkButton = document.createElement('div');
            checkButton.className = 'check-button';
            checkButton.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            
            questionElement.appendChild(questionTextElement);
            questionElement.appendChild(checkButton);
            
            // Поле для комментария (БЕЗ placeholder)
            const comment = document.createElement('textarea');
            comment.className = 'comment';
            comment.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            
            questionElement.appendChild(comment);
            
            // Обработчик для автоматической установки галочки при комментарии
            comment.addEventListener('input', function() {
                if (this.value.trim() !== '' && !checkButton.classList.contains('checked')) {
                    checkButton.classList.add('checked');
                    questionElement.classList.add('completed');
                    updateSectionStatus(sectionIndex);
                    updateProgressBar();
                }
                saveAnswer(sectionIndex, questionIndex, checkButton.classList.contains('checked') ? 'Проверено' : 'Не проверено', this.value);
                saveToLocalStorage(true);
            });
            
            // Обработчик для кнопки проверки
            checkButton.addEventListener('click', function() {
                const isChecked = this.classList.contains('checked');
                
                if (isChecked) {
                    this.classList.remove('checked');
                    questionElement.classList.remove('completed');
                } else {
                    this.classList.add('checked');
                    questionElement.classList.add('completed');
                }
                
                updateSectionStatus(sectionIndex);
                updateProgressBar();
                
                // Сохраняем состояние
                saveAnswer(sectionIndex, questionIndex, this.classList.contains('checked') ? 'Проверено' : 'Не проверено', comment.value);
                saveToLocalStorage(true);
            });
            
            return questionElement;
        }
        
        // Сохранить ответ
        function saveAnswer(sectionIndex, questionIndex, answer, comment = null) {
            if (!answers[sectionIndex]) {
                answers[sectionIndex] = {};
            }
            
            if (!answers[sectionIndex][questionIndex]) {
                answers[sectionIndex][questionIndex] = {};
            }
            
            answers[sectionIndex][questionIndex].answer = answer;
            answers[sectionIndex][questionIndex].comment = comment;
        }
        
        // Обновить статус секции
        function updateSectionStatus(sectionIndex) {
            const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
            const statusElement = section.querySelector('.section-status');
            
            const totalQuestions = sections[sectionIndex].questions.length + 1; // +1 для дополнительной информации
            const answeredQuestions = section.querySelectorAll('.check-button.checked').length;
            
            statusElement.textContent = `${answeredQuestions}/${totalQuestions}`;
        }
        
        // Обновить прогресс-бар
        function updateProgressBar() {
            const progressBar = document.getElementById('progress');
            
            let totalQuestions = 0;
            let answeredQuestions = 0;
            
            sections.forEach((section, index) => {
                totalQuestions += section.questions.length + 1; // +1 для дополнительной информации
                
                if (answers[index]) {
                    answeredQuestions += Object.keys(answers[index]).length;
                }
            });
            
            const progressPercentage = (answeredQuestions / totalQuestions) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }
        
        // Сохранить в LocalStorage
        function saveToLocalStorage(silent = false) {
            // Сохраняем состояние кнопок
            document.querySelectorAll('.check-button').forEach(button => {
                const questionId = button.dataset.questionId;
                const [sectionIndex, questionIndex] = questionId.split('-').map(Number);
                
                const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
                const comment = questionElement ? questionElement.querySelector('textarea') : null;
                
                saveAnswer(sectionIndex, questionIndex, button.classList.contains('checked') ? 'Проверено' : 'Не проверено', comment ? comment.value : null);
            });
            
            const timestamp = document.getElementById('timestamp').value;
            const data = {
                timestamp: timestamp,
                answers: answers,
                lastSaved: new Date().toLocaleString('ru-RU')
            };
            
            localStorage.setItem('tuberculosis_checklist_data', JSON.stringify(data));
            lastSaveTime = new Date();
            
            if (!silent) {
                alert('Данные сохранены в браузере!');
            }
            
            updateAutoSaveStatus();
        }
        
        // Обновить статус автосохранения
        function updateAutoSaveStatus() {
            const statusElement = document.getElementById('auto-save-status');
            if (lastSaveTime) {
                const timeString = lastSaveTime.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                statusElement.textContent = `Сохранено: ${timeString}`;
            }
        }
        
        // Загрузить из LocalStorage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('tuberculosis_checklist_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                answers = data.answers || {};
                
                // Восстановить ответы в интерфейсе
                Object.keys(answers).forEach(sectionIndex => {
                    Object.keys(answers[sectionIndex]).forEach(questionIndex => {
                        const answerData = answers[sectionIndex][questionIndex];
                        const questionElement = document.querySelector(`[data-question-id="${sectionIndex}-${questionIndex}"]`);
                        
                        if (questionElement) {
                            const checkButton = questionElement.querySelector('.check-button');
                            if (checkButton && answerData.answer === 'Проверено') {
                                checkButton.classList.add('checked');
                                questionElement.classList.add('completed');
                            }
                            
                            if (answerData.comment) {
                                const comment = questionElement.querySelector('textarea');
                                if (comment) {
                                    comment.value = answerData.comment;
                                }
                            }
                        }
                    });
                    updateSectionStatus(parseInt(sectionIndex));
                });
                
                updateProgressBar();
                updateAutoSaveStatus();
                
                // Обновить размер textarea после загрузки данных
                setTimeout(() => {
                    setupAutoResizeTextareas();
                }, 100);
            }
        }
        
        // Очистить форму
        function clearForm() {
            if (confirm('Вы уверены, что хотите очистить всю форму? Все данные будут удалены.')) {
                answers = {};
                localStorage.removeItem('tuberculosis_checklist_data');
                
                // Сбросить интерфейс
                document.querySelectorAll('.question').forEach(question => {
                    question.classList.remove('completed');
                    const checkButtons = question.querySelectorAll('.check-button');
                    checkButtons.forEach(button => button.classList.remove('checked'));
                    
                    const textareas = question.querySelectorAll('textarea');
                    textareas.forEach(textarea => {
                        textarea.value = '';
                        textarea.style.height = '60px';
                    });
                });
                
                document.querySelectorAll('.section-status').forEach(status => {
                    const sectionIndex = status.closest('.section').dataset.sectionIndex;
                    status.textContent = `0/${sections[sectionIndex].questions.length + 1}`;
                });
                
                updateProgressBar();
                updateAutoSaveStatus();
                
                alert('Форма очищена!');
            }
        }
        
        // Экспорт в Excel
        function exportToExcel() {
            const timestamp = document.getElementById('timestamp').value;
            const date = new Date(timestamp).toLocaleDateString('ru-RU');
            
            // Создаем рабочую книгу
            const wb = XLSX.utils.book_new();
            
            // Подготовка данных
            const excelData = [];
            
            // Заголовок документа
            excelData.push(["Чек-лист проверки организации противотуберкулезной помощи"]);
            excelData.push(["ГБУЗ МО МОКПТД"]);
            excelData.push(['Филиал "Клинский"']);
            excelData.push([`Дата проверки: ${date}`]);
            excelData.push([]); // Пустая строка
            
            // Заголовки столбцов
            excelData.push(["Раздел", "Вопрос", "Статус", "Комментарий"]);
            
            // Данные по разделам
            sections.forEach((section, sectionIndex) => {
                // Добавляем название раздела как отдельную строку
                excelData.push([section.title, "", "", ""]);
                
                // Вопросы раздела
                section.questions.forEach((question, questionIndex) => {
                    const answerData = answers[sectionIndex] && answers[sectionIndex][questionIndex];
                    const answer = answerData ? answerData.answer : 'Не проверено';
                    const comment = answerData && answerData.comment ? answerData.comment : '';
                    
                    excelData.push(["", question, answer, comment]);
                });
                
                // Дополнительная информация
                const additionalInfoIndex = section.questions.length;
                const additionalInfoData = answers[sectionIndex] && answers[sectionIndex][additionalInfoIndex];
                const additionalInfoAnswer = additionalInfoData ? additionalInfoData.answer : 'Не проверено';
                const additionalInfoComment = additionalInfoData && additionalInfoData.comment ? additionalInfoData.comment : '';
                
                excelData.push(["", "Дополнительная информация", additionalInfoAnswer, additionalInfoComment]);
                
                // Пустая строка между разделами
                excelData.push([]);
            });
            
            // Создаем лист
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Добавляем лист в книгу
            XLSX.utils.book_append_sheet(wb, ws, "Чек-лист ПТП");
            
            // Скачиваем файл
            XLSX.writeFile(wb, `чек-лист_птп_клинский_${date.replace(/\./g, '-')}.xlsx`);
        }
    </script>
</body>
</html>
